# VMware 无代理模式

## 支持的 vCenter/ESXi/存储版本

| 组件           | 支持版本                                   |
| -------------- | ------------------------------------------ |
| vCenter Server | 5.1, 5.5, 6.0, 6.5, 6.7, 7.0, 8.0(RC)      |
| ESXi           | 5.0, 5.1, 5.5, 6.0, 6.5, 6.7, 7.0, 8.0(RC) |
| VMFS           | 5.1, 5.2, 5.5, 5.8, 6.0, 6.5               |
| VSAN           | 6.5, 6.6, 7.0                              |

## 支持的客户机操作系统

详见[无代理模式支持矩阵](./product-support-overview.md)获取完整兼容性列表及最新支持状态。

## 基本要求

- **源端同步代理（Sync Proxy）节点**：Ubuntu 20.04，至少 2 核 CPU 和 4GB 内存
- **网络要求：**
  - 可访问 vCenter 管理网络地址及端口
  - 可访问 vCenter 管理的 ESXi 的 902 端口
  - 可访问云迁移/容灾平台（HyperMotion/HyperBDR Console）管理网络地址

## 支持与限制

### VMware 存储支持与限制

| 条件              | 支持版本/类型/要求                               | 不支持/限制说明                                                 |
| ----------------- | ------------------------------------------------ | --------------------------------------------------------------- |
| 虚拟硬件版本      | 5, 5.1, 5.5, 6.0, 6.5, 6.7, 7.0, 8.0(RC)         | 4 版本：仅支持全量数据同步                                      |
| 单磁盘容量        | ESXi 5.0/5.1 ≤2TB<br>ESXi 5.5 及以上支持>2TB     | ESXi 5.0/5.1：单盘>2TB 不支持                                   |
| 虚拟磁盘类型      | 基本磁盘（VMDK，非独立模式）                     | 独立模式磁盘需转为基本磁盘                                      |
| 远程 RDM 磁盘     | 不支持                                           | 不支持直接 LUN（SAN）访问                                       |
| USB/PCI 外设      | 不支持                                           | 挂载 USB/PCI 设备的虚拟机无法快照                               |
| 共享磁盘          | 修改为非共享模式（iscsi1:0.sharing=FALSE）后支持 | 共享模式不支持，必须设为非共享                                  |
| 挂载分区剩余空间  | 每个挂载分区（如/var、/boot、C:）需>100MB        | 空间不足可能导致演练或接管失败                                  |
| VMFS 版本         | 5.1, 5.2, 5.5, 5.8, 6.0, 6.5                     | 其他 VMFS 版本未测试/不支持                                     |
| VSAN 版本         | 6.5, 6.6, 7.0                                    | 其他 VSAN 版本未测试/不支持                                     |
| CBT（变更块跟踪） | 支持 VMFS/NFS 上的 VMDK，虚拟硬件 v7+，开机状态  | 不支持物理 RDM、独立磁盘、加密虚拟机、关机/挂起虚拟机、部分存储 |
| 快照数量          | ≤VMware 官方建议（如 32/64）                     | 快照过多可能导致性能下降或备份失败                              |
| 快照存储空间      | 需有足够可用空间                                 | 空间不足可能导致快照/备份失败                                   |
| 加密虚拟机        | 部分支持（取决于 vSphere 版本及 API 权限）       | 部分备份/恢复操作可能受限                                       |
| 虚拟机磁盘分布    | 所有磁盘位于受支持存储（VMFS/NFS）               | 磁盘分布于不支持的存储或跨不支持的数据存储                      |

### 客户机操作系统支持与限制

- 详见[无代理模式支持矩阵](./product-support-overview.md)获取详细支持的操作系统版本。
- 不支持同步使用远程 RDM 磁盘（直接访问 SAN LUN）的虚拟机。
- 不支持同步网络共享挂载目录（如 NFS/NAS），此类数据请使用文件级同步工具。
- 挂载 USB 或 PCI 外设的虚拟机无法快照（如加密狗等）。
- 配置共享磁盘的虚拟机需将共享磁盘设为非共享（iscsi1:0.sharing=FALSE）。
- 挂载分区（如 Linux 的/var、/boot 或其他分区，Windows 的 C:等）需有大于 100MB 可用空间。
- 关机或挂起的虚拟机无法进行增量备份（CBT 需开机）。
- 崩溃或状态异常的虚拟机无法可靠备份。
- 并非所有客户机操作系统都能保证应用一致性，若需应用感知备份，请确保已安装 VMware Tools 并考虑使用脚本或静默选项。
- 某些操作（如虚拟机迁移、磁盘扩容、快照恢复）后 CBT 数据可能失效，此时需重新全量备份。
- 备份期间不建议进行 Storage vMotion 或热添加操作，否则可能导致数据不一致。

## 性能与配置建议

- 单个源端同步代理（Sync Proxy）最大支持 100 台主机同步。
- 速率配置建议：
  - 需更高速率时，将`vmware_release_cpu_time=0`以提升同步效率。
  - 并发主机多时，将`vmware_release_cpu_time`设为并发主机数。

## 常见问题与注意事项

- 若源端 Windows 主机为 UEFI 启动，目标平台不支持原生 UEFI 启动时，需通过公网参与 UEFI 修复中转主机。
- 备份或快照操作期间，避免进行 Storage vMotion、虚拟机迁移、磁盘扩容或重配置，否则可能导致备份失败或数据不一致。
- 挂起或崩溃的虚拟机无法可靠备份，建议确保虚拟机开机且状态正常。
- 某些操作（如磁盘扩容、快照恢复、虚拟机迁移）会重置 CBT，需重新全量备份以建立增量链。
- 若快照链在备份软件外被破坏或删除，增量备份可能失败并需重新全量备份。
- 应用感知备份（如数据库、AD）需安装 VMware Tools 并启用静默或使用前后脚本。
- 仅在安装 VMware Tools 并启用静默时，才能保证文件系统一致性，否则仅为崩溃一致性。
- Sync Proxy 与 vCenter/ESXi 主机间需有足够带宽和低延迟，保障备份稳定高效。
- 过多并发备份任务可能影响 vCenter/ESXi 性能，建议遵循官方建议。
- 备份账号需具备足够的 vCenter/ESXi API 权限（如 Datastore.Browse、VirtualMachine.Snapshot、VirtualMachine.Backup 等）。
- 确保所用 VDDK 版本与 vSphere/ESXi 环境兼容。
- 虚拟机磁盘分布于多个数据存储时，备份/恢复可能有额外要求或限制。
- 部分存储加密或加密快照可能不支持备份/恢复。
- 虚拟机硬件重大变更（如更换 SCSI 控制器类型）后，需重新全量备份。
- 集群开启 DRS（分布式资源调度）时，若在同步/备份过程中触发虚拟机 vMotion 迁移，可能导致数据读取失败或同步中断。建议在同步/备份期间关闭 DRS 自动迁移，或将相关虚拟机设置为禁止自动迁移状态，以降低风险。
- 如果集群内存在多个第三方备份软件（如 Veeam、Commvault 等）同时对同一虚拟机基于 CBT 进行备份，可能导致 CBT 状态异常、快照冲突或备份失败。建议同一时间段内仅允许一个备份软件对同一虚拟机进行 CBT 备份，避免并发冲突。
