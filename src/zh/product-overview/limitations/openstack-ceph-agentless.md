# OpenStack（Ceph）无代理模式

## 支持的 OpenStack/Ceph 版本

| 组件      | 支持版本                                                                                                |
| --------- | ------------------------------------------------------------------------------------------------------- |
| OpenStack | Juno, Kilo, Liberty, Mitaka, Newton, Ocata, Pike, Queens, Rocky, Stein, Train, Ussri, Victoria, Wallaby |
| EasyStack | v3, v4, v5, v6                                                                                          |
| Ceph      | Jewel 10.2.11, Kraken 11.2.1, Luminous 12.2.13, Mimic 13.2.10, Nautilus 14.2.22, Octopus 15.2.16        |
| XSKY      | v4.0.2.0, v5.0.100.1                                                                                    |

## 支持的客户机操作系统

详见[云平台支持矩阵](https://oneprocloud.feishu.cn/sheets/VRqksSPEPhRTPStp3kVcItXNnyh?sheet=Y9fpqO)获取完整兼容性列表及最新支持状态。

## 基本要求

- **源端同步代理（Sync Proxy）节点**：Ubuntu 20.04，至少 2 核 CPU 和 4GB 内存
- **网络要求：**
  - 可访问 Ceph Monitor（默认端口 6789）及 OSD（默认端口 6800）
  - 可访问 OpenStack 平台 API 接口
  - 可访问云迁移/容灾平台（HyperMotion/HyperBDR Console）管理网络地址

## 支持与限制

### OpenStack 云平台接口要求

- 主机列表、详情及快照接口
- 主机规格详情接口
- 主机镜像创建及详情接口
- 卷列表和卷详情接口
- 卷快照列表和详情接口

### Ceph 接口要求

- Ceph 命令：状态查询、CRUSH MAP 查询
- RBD 相关命令：状态、信息获取、快照操作等

### 存储资源池要求

- 必须提供卷类型与 Ceph 存储池的对应关系。对于默认卷类型，当 OpenStack 平台中的卷类型为空时，平台对应的卷类型值为 DEFAULT_VOLUME_TYPE。
- 对于从镜像启动的主机，需提供对应主机本地卷的存储池信息。通常对应的存储池为 vms，平台卷类型的默认值为 CEPH_GLANCE_VMS。

### 存储与同步限制

| 条件             | 支持版本/类型/要求                        | 不支持/限制说明                                                                                        |
| ---------------- | ----------------------------------------- | ------------------------------------------------------------------------------------------------------ |
| 存储类型         | Ceph RBD、XSKY 等主流分布式块存储         | 其他存储类型未测试/不支持                                                                              |
| 卷类型           | 支持 OpenStack 平台标准卷类型             | 未配置卷类型或卷类型与存储池不匹配                                                                     |
| 远程挂载磁盘     | 不支持                                    | 不支持直接 LUN（SAN）访问                                                                              |
| 网络共享挂载目录 | 不支持                                    | 如 NFS/NAS 等网络共享目录需用文件级同步工具                                                            |
| 挂载分区剩余空间 | 每个挂载分区（如/var、/boot、C:）需>100MB | 空间不足可能导致演练或接管失败                                                                         |
| 客户机操作系统   | 详见支持矩阵                              | 部分老旧或定制 OS 可能不支持                                                                           |
| 虚拟机启动模式   | 卷启动/镜像启动                           | 不支持非标准镜像启动模式，虚拟机磁盘没有存储在底层 Ceph 的 images 存储池，而是通过其他方式进行引导启动 |

### 性能与配置建议

- 单个源端同步代理（Sync Proxy）最大支持 100 台主机同步。
- 源端同步代理（Sync Proxy） 的速率配置与并发同步主机数量相关：
  - （默认设置）若需要更高速率，建议将 `openstack_release_cpu_time` 设置为 0，以提升同步效率。
  - 若并发同步主机数量较多，建议将 `openstack_release_cpu_time` 设置为并发同步主机的数量。

## 常见问题与注意事项

- 备份或快照操作期间，避免进行主机迁移、卷扩容或重配置，否则可能导致同步失败或数据不一致。
- 部分操作（如卷扩容、快照恢复、主机迁移）可能导致同步链断裂，需重新全量同步。
- 若快照链在同步软件外被破坏或删除，增量同步可能失败并需重新全量同步。
- Sync Proxy 与 OpenStack/Ceph 集群间需有足够带宽和低延迟，保障同步稳定高效。
- 过多并发同步任务可能影响平台性能，建议遵循官方建议。
- 同一时间段内，同一虚拟机仅允许一个同步/备份软件进行增量同步，避免快照冲突。
- 备份账号需具备足够的 OpenStack/Ceph API 权限。
